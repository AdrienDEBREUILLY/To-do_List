<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Inclusion de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com" rel="stylesheet"></script>
    <title>To-do_List</title>
</head>
<body class="h-screen flex-row justify-center item-center">
    <!-- Barre de navigation -->
    <nav class="flex justify-between bg-purple-600 text-white p-4 sticky top-0 z-10">
        <ul class="flex space-x-4">
            <li><a href="./index.html" class="text-left hover:underline">To-do_List</a></li>
        </ul>
        <ul class="flex space-x-4">
            <li><a href="./login.html" class="hover:underline">Login</a></li>
            <li><a href="./logout.html" class="hover:underline">Logout</a></li>
            <li><a href="./signup.html" class="hover:underline">Signup</a></li>
        </ul>
    </nav>
    <div class="container mx-auto mt-5 p-5 bg-white rounded shadow-md">
        <h1 class="text-4xl text-center mb-5">To-do List</h1>
        <!-- Formulaire pour ajouter une nouvelle tâche -->
        <form class="mb-5">
            <div class="flex">
                <label for="new-task" class="sr-only">Ajouter une nouvelle tâche</label>
                <!-- Champ de saisie pour ajouter une nouvelle tâche -->
                <input type="text" id="new-task" name="taskText" placeholder="Add a new task..." class="flex-1 py-2 px-3 border border-gray-300 rounded mr-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <!-- Bouton pour ajouter une nouvelle tâche -->
                <button type="submit" class="bg-blue-500 text-white py-2 px-3 rounded hover:bg-blue-600">Add</button>
            </div>
        </form>
        <!-- Liste des tâches à faire -->
        <ul id="task-list" class="list-none">
            <!-- Les tâches seront ajoutées ici -->
        </ul>
        <!-- Liste des tâches terminées -->
        <ul id="completed-task-list" class="list-none mt-5">
            <!-- Les tâches terminées seront ajoutées ici -->
        </ul>
        <!-- Affichage des données consolées -->
        <!--<div id="console-output" class="mt-5 p-3 bg-gray-100 rounded">-->
        <!--    <h2 class="text-lg font-bold mb-2">Console Output</h2>-->
        <!--    <div id="console-output-content"></div>-->
        <!--</div>-->
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Sélection des éléments du DOM nécessaires
            const taskList = document.getElementById('task-list');
            const newTaskInput = document.getElementById('new-task');
            const completedTaskList = document.getElementById('completed-task-list');

            // Fonction pour définir la couleur de fond en fonction de la priorité
            const setBackgroundColor = (task) => {
                const priority = task.querySelector('select').value;
                switch (priority) {
                    case 'low':
                        task.style.backgroundColor = '#f5f5f5';
                        break;
                    case 'medium':
                        task.style.backgroundColor = '#ffffe6';
                        break;
                    case 'high':
                        task.style.backgroundColor = '#ffebd2';
                        break;
                    default:
                        task.style.backgroundColor = '#ffffff';
                }
            };

            // Fonction pour trier les tâches en fonction de leur priorité
            const sortTasks = () => {
                Array.from(taskList.children) // Convertir les éléments enfants en tableau
                    .sort((a, b) => {
                        const priorityOrder = { 'low': 3, 'medium': 2, 'high': 1 };
                        const aPriority = priorityOrder[a.querySelector('select').value];
                        const bPriority = priorityOrder[b.querySelector('select').value];
                        return aPriority - bPriority;
                    })
                    .forEach((task) => {
                        taskList.appendChild(task); // Réinsérer chaque tâche dans la liste triée
                    });
            };

            const generateTaskId = () => {
                return Date.now().toString(36) + Math.random().toString(36).substring(2, 9);
            };

            // Fonction pour afficher les données consolées dans l'élément div
            //const displayConsoleOutput = (taskId, taskText, taskDeadlineInput, taskNotes, taskPriority) => {
            //    const consoleOutputContent = document.getElementById('console-output-content');
            //    const outputHTML = `
            //        <p><strong>Task ID:</strong> ${taskId}</p>
            //        <p><strong>Task Text:</strong> ${taskText}</p>
            //        <p><strong>Task Deadline:</strong> ${taskDeadlineInput}</p>
            //        <p><strong>Task Notes:</strong> ${taskNotes}</p>
            //        <p><strong>Task Priority:</strong> ${taskPriority}</p>
            //        <hr>
            //    `;
            //    consoleOutputContent.innerHTML += outputHTML;
            //};

            // Ajouter une nouvelle tâche
            document.querySelector('form').addEventListener('submit', async (e) => {
                e.preventDefault(); // Empêcher le comportement par défaut du formulaire
                if (!newTaskInput.value.trim()) return; // Vérifier si le champ de saisie est vide

                const taskId = generateTaskId();  // Générer un identifiant unique

                // Création de l'élément de tâche
                const task = document.createElement('li');
                task.className = 'bg-white p-3 my-2 rounded shadow-md flex justify-between items-center';
                task.setAttribute('data-id', taskId);

                // Création des éléments de la tâche (texte, boutons, etc.)
                const taskContent = document.createElement('div');
                taskContent.className = 'flex-1';

                // Création de la case à cocher
                const taskCheckbox = document.createElement('input');
                taskCheckbox.type = 'checkbox';
                taskCheckbox.className = 'w-4 h-4 border border-gray-400 rounded cursor-pointer flex-shrink-0 mr-2';

                // Création du texte de la tâche
                const taskText = document.createElement('span');
                taskText.textContent = newTaskInput.value.trim();
                taskText.className = 'flex-1';

                // Création du bouton pour les notes
                const taskNotesButton = document.createElement('button');
                taskNotesButton.className = 'bg-yellow-500 text-white py-1 px-2 rounded mr-2 hover:bg-yellow-600';
                taskNotesButton.textContent = 'Notes';

                // Création de la zone de notes
                const taskNotes = document.createElement('textarea');
                taskNotes.style.display = 'none'; // Initialement cachée
                taskNotes.placeholder = 'Add notes...';

                // Création du conteneur pour les boutons
                const taskButtons = document.createElement('div');
                taskButtons.className = 'flex';

                // Création du champ pour la date de deadline
                const taskDeadlineInput = document.createElement('input');
                taskDeadlineInput.type = 'date';
                taskDeadlineInput.className = 'py-1 px-2 border border-gray-300 rounded mr-2';

                // Création de la liste déroulante pour la priorité
                const taskPriority = document.createElement('select');
                taskPriority.className = 'text-black py-1 px-2 rounded mr-2';
                taskPriority.innerHTML = `
                    <option value="default">default</option>
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                `;

                // Création du bouton pour l'édition de la tâche
                const taskEditButton = document.createElement('button');
                taskEditButton.dataset.id = taskId;
                taskEditButton.className = 'bg-blue-500 text-white py-1 px-2 rounded mr-2 hover:bg-blue-600';
                taskEditButton.textContent = 'Edit';

                // Création du bouton pour la suppression de la tâche
                const taskDelete = document.createElement('button');
                taskDelete.className = 'bg-red-500 text-white py-1 px-2 rounded hover:bg-red-600';
                taskDelete.textContent = 'Delete';

                // Ajout des éléments à la tâche
                task.appendChild(taskCheckbox);
                task.appendChild(taskText);
                task.appendChild(taskButtons);
                taskButtons.appendChild(taskPriority);
                taskButtons.appendChild(taskDeadlineInput);
                taskButtons.appendChild(taskNotes);
                taskButtons.appendChild(taskNotesButton);
                taskButtons.appendChild(taskEditButton);
                taskButtons.appendChild(taskDelete);
                taskList.appendChild(task);

                // Définir la couleur de fond en fonction de la priorité
                setBackgroundColor(task)

                // Ajout d'un événement pour changer la priorité
                taskPriority.addEventListener('change', () => {
                    setBackgroundColor(task);
                    sortTasks();
                });

                // Désactiver la case à cocher une fois cochée
                taskCheckbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        e.target.disabled = true; // Désactiver la case à cocher une fois cochée
                    }
                });

                // Réinitialiser la valeur de l'entrée
                newTaskInput.value = '';

                // Focus sur l'entrée
                newTaskInput.focus();

                // Ajouter un écouteur d'événement pour le bouton "Ajouter"
                document.querySelector('button[type="submit"]').addEventListener('click', () => {
                    sortTasks(); // Trier les tâches après l'ajout d'une nouvelle tâche
                });

                //displayConsoleOutput(taskId, taskText.textContent);
                await TaskToDatabase(taskId, taskText.textContent);

                taskPriority.addEventListener('change', async () => {
                    setBackgroundColor(task);
                    sortTasks();
                    //displayConsoleOutput(taskId, '', '', '', taskPriority.value);
                    await updateTaskPriorityToDatabase(taskId, taskPriority.value);
                });

                taskNotes.addEventListener('input', async () => {
                    //displayConsoleOutput(taskId, '', '', taskNotes.value, '');
                    await updateTaskNotesToDatabase(taskId, taskNotes.value);
                });

                taskDeadlineInput.addEventListener('change', async () => {
                    //displayConsoleOutput(taskId, '', taskDeadlineInput.value, '', '');
                    await updateTaskDeadlineInputToDatabase(taskId, taskDeadlineInput.value);
                });

            });

            // Toggle pour afficher/masquer les notes
            taskList.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && e.target.textContent === 'Notes') {
                    const task = e.target.closest('li');
                    const taskNotes = task.querySelector('textarea');
                    taskNotes.style.display = taskNotes.style.display === 'none' ? 'block' : 'none';
                }
            });

            // Validation d'une tâche
            taskList.addEventListener('change', async (e) => {
                if (e.target.tagName === 'INPUT' && e.target.type === 'checkbox') {
                    const task = e.target.closest('li');
                    const taskId = task.getAttribute('data-id');

                    if (e.target.checked) {
                        task.classList.toggle('line-through');
                        task.style.backgroundColor = '#b3ffb3'; // Ajout du fond vert aux tâches validées
                        task.querySelector('select').value = 'default'; // Réinitialiser la priorité à "default"
                        task.querySelector('select').disabled = true; // Désactiver la sélection de priorité
                        task.querySelector('input[type="date"]').disabled = true; // Désactiver la sélection de date
                        completedTaskList.appendChild(task); // Déplacer la tâche vers la liste des tâches terminées
                    } else { // ne fonctionne pas (raison unconnue)
                        task.classList.remove('line-through');
                        task.style.backgroundColor = ''; // Retirer le fond vert si la tâche n'est plus validée
                        task.querySelector('select').disabled = false; // Réactiver la sélection de priorité
                        task.querySelector('input[type="date"]').disabled = false; // Réactiver la sélection de date
                        task.querySelector('textarea').disabled = false; // Réactiver l'édition des notes
                        task.querySelector('button[data-id="edit"]').disabled = false; // Réactiver le bouton d'édition
                        taskList.appendChild(task); // Déplacer la tâche vers la liste des tâches en cours
                    }
                    await validateTaskInDatabase(taskId);
                }
            });

            // Supprimer une tâche
            const deleteTask = (task) => {
                task.remove();
            };            

            // Supprimer une tâche de la liste des tâches terminées
            completedTaskList.addEventListener('click', async (e) => {
                if (e.target.tagName === 'BUTTON' && e.target.textContent === 'Delete') {
                    const task = e.target.closest('li');
                    const taskId = task.getAttribute('data-id');
                    deleteTask(task);
                    await deleteTaskFromDatabase(taskId);
                }
            });

            // Modifier le nom d'une tâche
            taskList.addEventListener('click', async (e) => {
                if (e.target.tagName === 'BUTTON' && e.target.textContent === 'Edit') {
                    const task = e.target.closest('li');
                    const taskId = task.getAttribute('data-id');
                    const taskText = task.querySelector('span');
                    const newTaskText = prompt('Enter the new task text:');
                    if (newTaskText) {
                        taskText.textContent = newTaskText;
                    }
                    await updateTaskNameInDatabase(taskId, newTaskText);
                }
            });

            // appels de données pour les routes
            async function TaskToDatabase(taskId, taskText) {
                const formData = new FormData();
                formData.append('taskId', taskId);
                formData.append('taskText', taskText);

                try {
                    const response = await fetch('/addtache', {
                        method: 'post',
                        body: formData
                    });
                    if (response.ok) {
                        console.log('Tâche ajoutée avec succès à la base de données.');
                        // Réalisez les actions nécessaires après l'ajout de la tâche, par exemple, actualiser l'affichage des tâches
                    } else {
                        console.error('Erreur lors de l\'ajout de la tâche:', response.statusText);
                    }
                } catch (error) {
                    console.error('Erreur lors de la requête:', error.message);
                }
            }

            async function updateTaskDeadlineInputToDatabase(taskId, taskDeadlineInput) {
                const formData = new FormData();
                formData.append('taskId', taskId);
                formData.append('taskDeadlineInput', taskDeadlineInput);

                try {
                    const response = await fetch('/updatetache', {
                        method: 'put',
                        body: formData
                    });
                    if (response.ok) {
                        console.log('Tâche ajoutée avec succès à la base de données.');
                        // Réalisez les actions nécessaires après l'ajout de la tâche, par exemple, actualiser l'affichage des tâches
                    } else {
                        console.error('Erreur lors de l\'ajout de la tâche:', response.statusText);
                    }
                } catch (error) {
                    console.error('Erreur lors de la requête:', error.message);
                }
            }

            async function updateTaskNotesToDatabase(taskId, taskNotes) {
                const formData = new FormData();
                formData.append('taskId', taskId);
                formData.append('taskNotes', taskNotes);

                try {
                    const response = await fetch('/upnotetache', {
                        method: 'put',
                        body: formData
                    });
                    if (response.ok) {
                        console.log('Tâche ajoutée avec succès à la base de données.');
                        // Réalisez les actions nécessaires après l'ajout de la tâche, par exemple, actualiser l'affichage des tâches
                    } else {
                        console.error('Erreur lors de l\'ajout de la tâche:', response.statusText);
                    }
                } catch (error) {
                    console.error('Erreur lors de la requête:', error.message);
                }
            }

            async function updateTaskPriorityToDatabase(taskId, taskPriority) {
                const formData = new FormData();
                formData.append('taskId', taskId);
                formData.append('taskPriority', taskPriority);

                try {
                    const response = await fetch('/uppriotache', {
                        method: 'put',
                        body: formData
                    });
                    if (response.ok) {
                        console.log('Tâche ajoutée avec succès à la base de données.');
                        // Réalisez les actions nécessaires après l'ajout de la tâche, par exemple, actualiser l'affichage des tâches
                    } else {
                        console.error('Erreur lors de l\'ajout de la tâche:', response.statusText);
                    }
                } catch (error) {
                    console.error('Erreur lors de la requête:', error.message);
                }
            }

            async function validateTaskInDatabase(taskId) {
                const formData = new FormData();
                formData.append('taskId', taskId);

                try {
                    const response = await fetch('/valider-tache', {
                        method: 'put',
                        body: formData
                    });
                    if (response.ok) {
                        console.log('Tâche validée avec succès dans la base de données.');
                        // Réalisez les actions nécessaires après la validation de la tâche, par exemple, actualiser l'affichage des tâches
                    } else {
                        console.error('Erreur lors de la validation de la tâche:', response.statusText);
                    }
                } catch (error) {
                    console.error('Erreur lors de la requête:', error.message);
                }
            }

            async function updateTaskNameInDatabase(taskId, newTaskText) {
                const formData = new FormData();
                formData.append('taskId', taskId);
                formData.append('newTaskText', newTaskText);

                try {
                    const response = await fetch('/modifier-nom-tache', {
                        method: 'put',
                        body: formData
                    });
                    if (response.ok) {
                        console.log('Tâche modifiée avec succès dans la base de données.');
                        // Réalisez les actions nécessaires après la modification de la tâche, par exemple, actualiser l'affichage des tâches
                    } else {
                        console.error('Erreur lors de la modification de la tâche:', response.statusText);
                    }
                } catch (error) {
                    console.error('Erreur lors de la requête:', error.message);
                }
            }

            async function deleteTaskFromDatabase(taskId) {
                const formData = new FormData();
                formData.append('taskId', taskId);

                try {
                    const response = await fetch('/supprimer-tache', {
                        method: 'delete',
                        body: formData
                    });
                    if (response.ok) {
                        console.log('Tâche supprimée avec succès de la base de données.');
                        // Réalisez les actions nécessaires après la suppression de la tâche, par exemple, actualiser l'affichage des tâches
                    } else {
                        console.error('Erreur lors de la suppression de la tâche:', response.statusText);
                    }
                } catch (error) {
                    console.error('Erreur lors de la requête:', error.message);
                }
            }
        });
    </script>
</body>
</html>
